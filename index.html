<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontierra - Microtonal Pitch-Bending Audio Player</title>
    <!-- Import Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
            background-color: #fff0f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            width: 100%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
        }
        
        h1 {
            color: #ff69b4;
            text-align: center;
            font-weight: 300;
            letter-spacing: 3px;
            margin-bottom: 20px;
            font-size: 2.2rem;
            text-transform: uppercase;
        }
        
        .upload-area {
            border: 2px dashed #ff69b4;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .upload-area:hover {
            background-color: rgba(255, 105, 180, 0.1);
        }
        
        .upload-label {
            display: block;
            color: #ff69b4;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        #file-input {
            display: none;
        }
        
        .playing-label {
            margin: 15px 0;
            font-weight: 500;
            color: #555;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #ff69b4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        button:hover:not(:disabled) {
            background-color: #ff4eaa;
        }
        
        button:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        button:disabled {
            background-color: #ffb6d9;
            cursor: not-allowed;
        }
        
        .pitch-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .pitch-btn {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .arrow-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .arrow-btn {
            background-color: white;
            color: #ff69b4;
            border: 2px solid #ff69b4;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            border-radius: 50%;
        }
        
        .adsr-panel {
            background-color: #fff0f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .slider-container {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: #ffcce6;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ff69b4;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ff69b4;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .status-info {
            text-align: center;
            font-style: italic;
            color: #777;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Frontierra</h1>
        
        <!-- File Upload Section -->
        <div class="upload-area" id="upload-area">
            <span class="upload-label">Drop WAV or MIDI files here or click to upload</span>
            <input type="file" id="file-input" accept=".wav,.mid,.midi">
        </div>
        
        <!-- Currently Playing Section -->
        <div class="playing-label" id="playing-label">No file loaded</div>
        
        <!-- Playback Controls -->
        <div class="controls">
            <button id="play-btn" disabled>Play</button>
            <button id="stop-btn" disabled>Stop</button>
        </div>
        
        <!-- Pitch Bend Controls -->
        <div class="pitch-controls">
            <button id="lower-pitch" class="pitch-btn">↓ Lower Pitch</button>
            <button id="raise-pitch" class="pitch-btn">↑ Raise Pitch</button>
        </div>
        
        <div class="arrow-controls">
            <button id="left-arrow" class="arrow-btn">←</button>
            <button id="right-arrow" class="arrow-btn">→</button>
        </div>
        
        <!-- ADSR and Volume Controls -->
        <div class="adsr-panel">
            <h3 style="margin-top: 0; color: #ff69b4; text-align: center;">ADSR & Volume</h3>
            
            <div class="slider-container">
                <label for="attack">Attack: <span id="attack-value">0.1</span>s</label>
                <input type="range" id="attack" min="0" max="2" step="0.01" value="0.1">
            </div>
            
            <div class="slider-container">
                <label for="decay">Decay: <span id="decay-value">0.2</span>s</label>
                <input type="range" id="decay" min="0" max="2" step="0.01" value="0.2">
            </div>
            
            <div class="slider-container">
                <label for="sustain">Sustain: <span id="sustain-value">0.5</span></label>
                <input type="range" id="sustain" min="0" max="1" step="0.01" value="0.5">
            </div>
            
            <div class="slider-container">
                <label for="release">Release: <span id="release-value">0.5</span>s</label>
                <input type="range" id="release" min="0" max="2" step="0.01" value="0.5">
            </div>
            
            <div class="slider-container">
                <label for="volume">Volume: <span id="volume-value">0.8</span></label>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8">
            </div>
        </div>
        
        <div class="status-info">
            Use arrow keys on your keyboard for fine pitch adjustments
        </div>
    </div>

    <script>
        // =====================================================
        // Global Variables
        // =====================================================
        let audioContext;
        let gainNode;
        let bufferSource;
        let audioBuffer;
        let midiData;
        let synth;
        let isPlaying = false;
        let currentPitch = 0; // in cents
        let pitchIntervals = {};
        let fileType = null; // 'wav' or 'midi'
        let currentFileName = "";
        
        // DOM Elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const playingLabel = document.getElementById('playing-label');
        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const lowerPitchBtn = document.getElementById('lower-pitch');
        const raisePitchBtn = document.getElementById('raise-pitch');
        const leftArrowBtn = document.getElementById('left-arrow');
        const rightArrowBtn = document.getElementById('right-arrow');
        
        // ADSR and Volume Elements
        const attackSlider = document.getElementById('attack');
        const decaySlider = document.getElementById('decay');
        const sustainSlider = document.getElementById('sustain');
        const releaseSlider = document.getElementById('release');
        const volumeSlider = document.getElementById('volume');
        
        const attackValue = document.getElementById('attack-value');
        const decayValue = document.getElementById('decay-value');
        const sustainValue = document.getElementById('sustain-value');
        const releaseValue = document.getElementById('release-value');
        const volumeValue = document.getElementById('volume-value');
        
        // =====================================================
        // Setup and Initialization
        // =====================================================
        function init() {
            // Initialize audio context on user interaction
            document.addEventListener('click', initAudioContext, { once: true });
            
            // Set up file upload handlers
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(255, 105, 180, 0.2)';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '';
            });
            uploadArea.addEventListener('drop', handleFileDrop);
            
            // Set up playback controls
            playBtn.addEventListener('click', handlePlay);
            stopBtn.addEventListener('click', handleStop);
            
            // Set up pitch bending controls
            setupPitchBending();
            
            // Set up ADSR and volume controls
            setupADSRControls();
            
            // Set up keyboard events
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
        }
        
        function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.gain.value = volumeSlider.value;
                gainNode.connect(audioContext.destination);
                
                // Initialize Tone.js
                Tone.context = audioContext;
                
                // Create default synth
                synth = new Tone.Synth({
                    oscillator: {
                        type: 'sine'
                    },
                    envelope: {
                        attack: parseFloat(attackSlider.value),
                        decay: parseFloat(decaySlider.value),
                        sustain: parseFloat(sustainSlider.value),
                        release: parseFloat(releaseSlider.value)
                    }
                }).toDestination();
                
                // Set initial volume
                Tone.Destination.volume.value = Tone.gainToDb(parseFloat(volumeSlider.value));
            } catch (error) {
                console.error("Error initializing audio context:", error);
            }
        }
        
        // =====================================================
        // File Handling
        // =====================================================
        function handleFileDrop(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        }
        
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            // Get file extension
            const extension = file.name.split('.').pop().toLowerCase();
            
            // Check if file type is valid
            if (['wav', 'mid', 'midi'].includes(extension)) {
                currentFileName = file.name;
                playingLabel.textContent = `Loading: ${file.name}...`;
                
                // Disable play/stop buttons during loading
                playBtn.disabled = true;
                stopBtn.disabled = true;
                
                // Reset current pitch
                currentPitch = 0;
                
                // Process file based on type
                if (extension === 'wav') {
                    fileType = 'wav';
                    processWavFile(file);
                } else {
                    fileType = 'midi';
                    processMidiFile(file);
                }
            } else {
                playingLabel.textContent = "Error: Only WAV and MIDI files are supported.";
            }
        }
        
        // =====================================================
        // WAV File Processing
        // =====================================================
        function processWavFile(file) {
            try {
                // Make sure audio context is initialized
                if (!audioContext) {
                    initAudioContext();
                }
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        // Decode the audio data
                        audioBuffer = await audioContext.decodeAudioData(e.target.result);
                        
                        // Update UI to show loaded state
                        playingLabel.textContent = `Loaded: ${currentFileName}`;
                        playBtn.disabled = false;
                        stopBtn.disabled = false;
                    } catch (decodeError) {
                        console.error("Error decoding WAV file:", decodeError);
                        playingLabel.textContent = `Error loading ${currentFileName}: Invalid format`;
                    }
                };
                
                reader.onerror = () => {
                    console.error("Error reading file");
                    playingLabel.textContent = "Error reading file";
                };
                
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error processing WAV file:", error);
                playingLabel.textContent = "Error processing WAV file";
            }
        }
        
        // =====================================================
        // MIDI File Processing
        // =====================================================
        function processMidiFile(file) {
            try {
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        // Make sure Tone.js is initialized
                        await Tone.start();
                        
                        // Load MIDI file
                        const midiArrayBuffer = e.target.result;
                        const midi = await Tone.Midi.parse(midiArrayBuffer);
                        
                        // Store MIDI data
                        midiData = midi;
                        
                        // Update UI to show loaded state
                        playingLabel.textContent = `Loaded: ${currentFileName}`;
                        playBtn.disabled = false;
                        stopBtn.disabled = false;
                    } catch (parseError) {
                        console.error("Error parsing MIDI file:", parseError);
                        playingLabel.textContent = `Error loading ${currentFileName}: Invalid MIDI format`;
                    }
                };
                
                reader.onerror = () => {
                    console.error("Error reading file");
                    playingLabel.textContent = "Error reading file";
                };
                
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error processing MIDI file:", error);
                playingLabel.textContent = "Error processing MIDI file";
            }
        }
        
        // =====================================================
        // Playback Controls
        // =====================================================
        function handlePlay() {
            if (isPlaying) return;
            
            try {
                if (fileType === 'wav') {
                    playWavFile();
                } else if (fileType === 'midi') {
                    playMidiFile();
                }
                
                isPlaying = true;
                playBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (error) {
                console.error("Error playing file:", error);
                playingLabel.textContent = "Error playing file";
            }
        }
        
        function handleStop() {
            if (!isPlaying) return;
            
            try {
                if (fileType === 'wav') {
                    stopWavFile();
                } else if (fileType === 'midi') {
                    stopMidiFile();
                }
                
                isPlaying = false;
                playBtn.disabled = false;
                stopBtn.disabled = true;
            } catch (error) {
                console.error("Error stopping playback:", error);
            }
        }
        
        function playWavFile() {
            // Create a new AudioBufferSourceNode
            bufferSource = audioContext.createBufferSource();
            bufferSource.buffer = audioBuffer;
            
            // Apply current pitch
            applyPitchToWav();
            
            // Connect to gain node
            bufferSource.connect(gainNode);
            
            // Setup ended callback
            bufferSource.onended = () => {
                if (isPlaying) {
                    handleStop();
                }
            };
            
            // Start playback
            bufferSource.start();
            playingLabel.textContent = `Playing: ${currentFileName}`;
        }
        
        function stopWavFile() {
            if (bufferSource) {
                bufferSource.stop();
                bufferSource = null;
            }
            playingLabel.textContent = `Stopped: ${currentFileName}`;
        }
        
        function playMidiFile() {
            // Ensure Tone.js is started
            Tone.start();
            
            // Reset synth's envelope parameters
            updateSynthEnvelope();
            
            // Play the first track with notes
            const tracks = midiData.tracks.filter(track => track.notes.length > 0);
            
            if (tracks.length > 0) {
                const notes = tracks[0].notes;
                
                // Create a sequence of notes
                const now = Tone.now();
                
                notes.forEach(note => {
                    // Apply pitch bend
                    const adjustedFreq = getAdjustedMidiFrequency(note.midi);
                    
                    // Trigger the note
                    synth.triggerAttackRelease(
                        adjustedFreq,
                        note.duration,
                        note.time + now
                    );
                });
                
                playingLabel.textContent = `Playing: ${currentFileName}`;
                
                // Stop playback after the last note
                if (notes.length > 0) {
                    const lastNote = notes[notes.length - 1];
                    const totalDuration = lastNote.time + lastNote.duration;
                    
                    setTimeout(() => {
                        if (isPlaying) {
                            handleStop();
                        }
                    }, totalDuration * 1000);
                }
            } else {
                playingLabel.textContent = `No notes found in ${currentFileName}`;
                handleStop();
            }
        }
        
        function stopMidiFile() {
            // Release all notes
            synth.triggerRelease();
            playingLabel.textContent = `Stopped: ${currentFileName}`;
        }
        
        // =====================================================
        // Pitch Bending
        // =====================================================
        function setupPitchBending() {
            // Mouse events for pitch buttons
            lowerPitchBtn.addEventListener('mousedown', () => startPitchChange(-2));
            lowerPitchBtn.addEventListener('mouseup', stopPitchChange);
            lowerPitchBtn.addEventListener('mouseleave', stopPitchChange);
            
            raisePitchBtn.addEventListener('mousedown', () => startPitchChange(2));
            raisePitchBtn.addEventListener('mouseup', stopPitchChange);
            raisePitchBtn.addEventListener('mouseleave', stopPitchChange);
            
            // Arrow button events
            leftArrowBtn.addEventListener('mousedown', () => startPitchChange(-2));
            leftArrowBtn.addEventListener('mouseup', stopPitchChange);
            leftArrowBtn.addEventListener('mouseleave', stopPitchChange);
            
            rightArrowBtn.addEventListener('mousedown', () => startPitchChange(2));
            rightArrowBtn.addEventListener('mouseup', stopPitchChange);
            rightArrowBtn.addEventListener('mouseleave', stopPitchChange);
            
            // Touch events for mobile
            lowerPitchBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startPitchChange(-2);
            });
            lowerPitchBtn.addEventListener('touchend', stopPitchChange);
            
            raisePitchBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startPitchChange(2);
            });
            raisePitchBtn.addEventListener('touchend', stopPitchChange);
            
            leftArrowBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startPitchChange(-2);
            });
            leftArrowBtn.addEventListener('touchend', stopPitchChange);
            
            rightArrowBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startPitchChange(2);
            });
            rightArrowBtn.addEventListener('touchend', stopPitchChange);
        }
        
        function startPitchChange(amount) {
            // Clear any existing interval
            stopPitchChange();
            
            // Immediately change pitch
            changePitch(amount);
            
            // Set interval for continuous change
            pitchIntervals[amount] = setInterval(() => changePitch(amount), 50);
        }
        
        function stopPitchChange() {
            // Clear all intervals
            Object.keys(pitchIntervals).forEach(key => {
                clearInterval(pitchIntervals[key]);
                delete pitchIntervals[key];
            });
        }
        
        function changePitch(amount) {
            currentPitch += amount;
            
            // Apply pitch change based on file type
            if (isPlaying) {
                if (fileType === 'wav' && bufferSource) {
                    applyPitchToWav();
                }
                // For MIDI, pitch will be applied on next note trigger
            }
            
            // Update UI to show current pitch
            playingLabel.textContent = `${isPlaying ? 'Playing' : 'Loaded'}: ${currentFileName} (Pitch: ${currentPitch > 0 ? '+' : ''}${currentPitch} cents)`;
        }
        
        function applyPitchToWav() {
            if (bufferSource) {
                // Formula: 2^(cents/1200)
                const rate = Math.pow(2, currentPitch / 1200);
                bufferSource.playbackRate.value = rate;
            }
        }
        
        function getAdjustedMidiFrequency(midiNote) {
            // Standard formula: 440 * 2^((n-69)/12)
            // With cents adjustment: 440 * 2^((n-69)/12) * 2^(cents/1200)
            const frequency = 440 * Math.pow(2, (midiNote - 69) / 12) * Math.pow(2, currentPitch / 1200);
            return frequency;
        }
        
        // =====================================================
        // Keyboard Controls
        // =====================================================
        function handleKeyDown(e) {
            if (e.repeat) return; // Prevent multiple events for key hold
            
            switch (e.key) {
                case 'ArrowLeft':
                    startPitchChange(-2);
                    leftArrowBtn.classList.add('active');
                    break;
                case 'ArrowRight':
                    startPitchChange(2);
                    rightArrowBtn.classList.add('active');
                    break;
                case 'ArrowDown':
                    startPitchChange(-2);
                    lowerPitchBtn.classList.add('active');
                    break;
                case 'ArrowUp':
                    startPitchChange(2);
                    raisePitchBtn.classList.add('active');
                    break;
                case ' ': // Space bar
                    e.preventDefault();
                    if (!isPlaying && !playBtn.disabled) {
                        handlePlay();
                    } else if (isPlaying) {
                        handleStop();
                    }
                    break;
            }
        }
        
        function handleKeyUp(e) {
            switch (e.key) {
                case 'ArrowLeft':
                case 'ArrowRight':
                case 'ArrowDown':
                case 'ArrowUp':
                    stopPitchChange();
                    leftArrowBtn.classList.remove('active');
                    rightArrowBtn.classList.remove('active');
                    lowerPitchBtn.classList.remove('active');
                    raisePitchBtn.classList.remove('active');
                    break;
            }
        }
        
        // =====================================================
        // ADSR and Volume Controls
        // =====================================================
        function setupADSRControls() {
            // Update display values and connect to sliders
            attackSlider.addEventListener('input', updateADSR);
            decaySlider.addEventListener('input', updateADSR);
            sustainSlider.addEventListener('input', updateADSR);
            releaseSlider.addEventListener('input', updateADSR);
            volumeSlider.addEventListener('input', updateVolume);
        }
        
        function updateADSR() {
            // Update display values
            attackValue.textContent = attackSlider.value;
            decayValue.textContent = decaySlider.value;
            sustainValue.textContent = sustainSlider.value;
            releaseValue.textContent = releaseSlider.value;
            
            // Update synth parameters if it exists
            updateSynthEnvelope();
        }
        
        function updateSynthEnvelope() {
            if (synth) {
                synth.envelope.attack = parseFloat(attackSlider.value);
                synth.envelope.decay = parseFloat(decaySlider.value);
                synth.envelope.sustain = parseFloat(sustainSlider.value);
                synth.envelope.release = parseFloat(releaseSlider.value);
            }
        }
        
        function updateVolume() {
            volumeValue.textContent = volumeSlider.value;
            
            // Update gain for WAV playback
            if (gainNode) {
                gainNode.gain.value = parseFloat(volumeSlider.value);
            }
            
            // Update volume for MIDI playback
            if (Tone.Destination) {
                Tone.Destination.volume.value = Tone.gainToDb(parseFloat(volumeSlider.value));
            }
        }
        
        // Initialize app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>