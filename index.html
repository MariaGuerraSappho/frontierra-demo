<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frontierra</title>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #fff0f5; color: #ff69b4; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
    .container { max-width: 600px; width: 100%; text-align: center; }
    h1 { font-size: 2.5em; margin-bottom: 40px; font-weight: 300; letter-spacing: 3px; }
    .file-upload { margin: 20px 0; }
    .upload-btn { position: relative; display: inline-block; width: 100%; border: 2px dashed #ff69b4; padding: 20px; border-radius: 10px; color: #ff69b4; cursor: pointer; transition: all 0.3s; background: none; font-size: 1em; text-align: center; }
    .upload-btn:hover { background: rgba(255, 105, 180, 0.1); }
    .upload-btn input { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .currently-playing { margin: 20px 0; font-style: italic; }
    .pitch-display { margin: 10px 0; font-size: 1.2em; }
    .playback-controls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .playback-btn { background: #ff69b4; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 10px; color: white; cursor: pointer; transition: all 0.2s; }
    .playback-btn:hover { background: #ff1493; }
    .playback-btn:disabled { background: #ffb6c6; cursor: not-allowed; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 40px 0; }
    .pitch-btn { background: #ff69b4; border: none; padding: 40px; font-size: 1.5em; border-radius: 15px; color: white; cursor: pointer; transition: all 0.2s; }
    .pitch-btn:hover { transform: scale(1.02); background: #ff1493; }
    .arrow-controls { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
    .arrow-btn { background: #ff69b4; border: none; padding: 10px 15px; border-radius: 5px; color: white; cursor: pointer; }
    .adsr-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; padding: 20px; background: rgba(255, 105, 180, 0.1); border-radius: 10px; }
    .adsr-control { display: flex; flex-direction: column; align-items: center; }
    input[type="range"] { width: 100%; margin: 10px 0; -webkit-appearance: none; height: 2px; background: #ff69b4; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: #ff69b4; border-radius: 50%; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Frontierra</h1>
    <div class="file-upload">
      <label class="upload-btn">
        Upload WAV or MIDI File
        <input type="file" id="audioFile" accept="audio/*,.wav,.midi,.mid" />
      </label>
    </div>
    <div class="currently-playing" id="currentFile">No file loaded</div>
    <div class="pitch-display" id="pitchDisplay">Pitch: 0 cents</div>
    <div class="playback-controls">
      <button class="playback-btn" id="playBtn" disabled>Play</button>
      <button class="playback-btn" id="stopBtn" disabled>Stop</button>
    </div>
    <div class="controls">
      <button class="pitch-btn" id="pitchDown">↓ Lower Pitch</button>
      <button class="pitch-btn" id="pitchUp">↑ Raise Pitch</button>
    </div>
    <div class="arrow-controls">
      <button class="arrow-btn" id="arrowLeft">←</button>
      <button class="arrow-btn" id="arrowRight">→</button>
    </div>
    <div class="adsr-controls">
      <div class="adsr-control"><label>Attack</label><input type="range" id="attack" min="0" max="2" step="0.1" value="0.1"></div>
      <div class="adsr-control"><label>Decay</label><input type="range" id="decay" min="0" max="2" step="0.1" value="0.2"></div>
      <div class="adsr-control"><label>Sustain</label><input type="range" id="sustain" min="0" max="1" step="0.1" value="0.5"></div>
      <div class="adsr-control"><label>Release</label><input type="range" id="release" min="0" max="2" step="0.1" value="0.5"></div>
      <div class="adsr-control"><label>Volume</label><input type="range" id="volume" min="0" max="1" step="0.1" value="0.7"></div>
    </div>
  </div>

  <script type="importmap">
  {
    "imports": { "tone": "https://unpkg.com/tone@14.7.77/build/Tone.js" }
  }
  </script>
  <script type="module">
    import * as Tone from 'tone';

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let wavBuffer = null;
    let wavSource = null;
    const gainNode = audioCtx.createGain();
    gainNode.connect(audioCtx.destination);

    let isMidi = false;
    let midiNotes = [];
    let synth = null;

    let isPlaying = false;
    let currentPitch = 0;

    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const currentFileLabel = document.getElementById('currentFile');
    const pitchDisplay = document.getElementById('pitchDisplay');

    async function initSynth() {
      if (synth) synth.dispose();
      synth = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: {
          attack: parseFloat(document.getElementById('attack').value),
          decay: parseFloat(document.getElementById('decay').value),
          sustain: parseFloat(document.getElementById('sustain').value),
          release: parseFloat(document.getElementById('release').value)
        }
      }).toDestination();
      synth.volume.value = Tone.gainToDb(parseFloat(document.getElementById('volume').value));
    }

    function updateADSR() {
      if (!synth) return;
      synth.envelope.attack = parseFloat(document.getElementById('attack').value);
      synth.envelope.decay = parseFloat(document.getElementById('decay').value);
      synth.envelope.sustain = parseFloat(document.getElementById('sustain').value);
      synth.envelope.release = parseFloat(document.getElementById('release').value);
      gainNode.gain.value = parseFloat(document.getElementById('volume').value);
    }

    document.getElementById('audioFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (isPlaying) stopPlayback();
      isPlaying = false;
      playBtn.textContent = 'Play';
      currentPitch = 0; pitchDisplay.textContent = 'Pitch: 0 cents';
      playBtn.disabled = stopBtn.disabled = true;
      currentFileLabel.textContent = `Loading: ${file.name}…`;

      if (file.name.toLowerCase().endsWith('.mid') || file.name.toLowerCase().endsWith('.mIDI')) {
        isMidi = true;
        const arrayBuffer = await file.arrayBuffer();
        const midi = new Tone.Midi(arrayBuffer);
        midiNotes = midi.tracks[0].notes;
        await initSynth();
        currentFileLabel.textContent = `Loaded: ${file.name}`;
        playBtn.disabled = stopBtn.disabled = false;
      } else {
        isMidi = false;
        const arrayBuffer = await file.arrayBuffer();
        wavBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        currentFileLabel.textContent = `Loaded: ${file.name}`;
        playBtn.disabled = stopBtn.disabled = false;
      }
    });

    async function startPlayback() {
      if (isMidi) {
        await Tone.start();
        const now = Tone.now();
        midiNotes.forEach(note => {
          synth.triggerAttackRelease(
            Tone.Frequency(note.midi + currentPitch/100, 'midi'),
            note.duration,
            note.time + now
          );
        });
      } else if (wavBuffer) {
        wavSource?.stop();
        wavSource = audioCtx.createBufferSource();
        wavSource.buffer = wavBuffer;
        wavSource.playbackRate.value = Math.pow(2, currentPitch/1200);
        wavSource.connect(gainNode);
        wavSource.start();
      }
      isPlaying = true;
      playBtn.textContent = 'Restart';
      stopBtn.disabled = false;
    }

    function stopPlayback() {
      if (isMidi && synth) synth.triggerRelease();
      else if (wavSource) wavSource.stop();
      isPlaying = false;
      playBtn.textContent = 'Play';
    }

    playBtn.addEventListener('click', () => startPlayback());
    stopBtn.addEventListener('click', stopPlayback);

    function changePitch(cents) {
      currentPitch += cents;
      pitchDisplay.textContent = `Pitch: ${currentPitch.toFixed(1)} cents`;
      if (wavSource && isPlaying && !isMidi) {
        wavSource.playbackRate.value = Math.pow(2, currentPitch/1200);
      }
    }

    ['pitchUp','pitchDown','arrowLeft','arrowRight'].forEach(id => {
      const btn = document.getElementById(id);
      let interval;
      btn.addEventListener('mousedown', () => interval = setInterval(() => changePitch((id.includes('Up')||id==='arrowRight')?2:-2), 50));
      ['mouseup','mouseleave'].forEach(evt => btn.addEventListener(evt, () => clearInterval(interval)));
    });

    window.addEventListener('keydown', e => {
      if (['ArrowUp','ArrowRight','ArrowDown','ArrowLeft'].includes(e.key)) {
        e.preventDefault();
        changePitch((e.key==='ArrowUp'||e.key==='ArrowRight')?2:-2);
      }
    });

    document.querySelectorAll('.adsr-controls input').forEach(input => input.addEventListener('input', updateADSR));
  </script>
</body>
</html>
