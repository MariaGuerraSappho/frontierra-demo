<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frontierra</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #fff0f5; color: #ff69b4; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; user-select: none; -webkit-tap-highlight-color: transparent; }
    .container { max-width: 600px; width: 100%; text-align: center; }
    h1 { font-size: 2.5em; margin: 0 0 10px; font-weight: 300; letter-spacing: 3px; }
    .build-number { margin-bottom: 20px; font-size: 0.9em; color: #aaa; }
    .file-upload { margin: 20px 0; width: 100%; }
    .upload-btn { position: relative; display: inline-block; width: 100%; border: 2px dashed #ff69b4; padding: 20px; border-radius: 10px; color: #ff69b4; font-size: 1em; cursor: pointer; transition: background 0.3s; background: none; touch-action: manipulation; }
    .upload-btn:hover { background: rgba(255,105,180,0.1); }
    .upload-btn input { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .currently-playing { margin: 10px 0; font-style: italic; }
    .pitch-display { margin: 10px 0; font-size: 1.2em; }
    .playback-controls { display: flex; gap: 10px; margin: 15px 0; width: 100%; }
    .playback-btn { flex: 1; background: #ff69b4; border: none; padding: 15px; font-size: 1.1em; border-radius: 8px; color: white; cursor: pointer; transition: background 0.2s; touch-action: manipulation; }
    .playback-btn:hover { background: #ff1493; }
    .playback-btn:disabled { background: #ffb6c6; cursor: not-allowed; }
    .controls { display: flex; gap: 10px; margin: 20px 0; width: 100%; }
    .pitch-btn { flex: 1; background: #ff69b4; border: none; padding: 20px; font-size: 1.3em; border-radius: 8px; color: white; cursor: pointer; transition: background 0.2s; touch-action: manipulation; user-select: none; }
    .pitch-btn:hover { background: #ff1493; }
    .adsr-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; padding: 20px; background: rgba(255,105,180,0.1); border-radius: 10px; width: 100%; }
    .adsr-control { display: flex; flex-direction: column; align-items: center; }
    input[type="range"] { width: 100%; margin: 10px 0; -webkit-appearance: none; height: 2px; background: #ff69b4; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: #ff69b4; border-radius: 50%; cursor: pointer; }
    @media (max-width: 480px) { .pitch-btn { padding: 15px; font-size: 1.1em; } .playback-btn { padding: 12px; font-size: 1em; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Frontierra</h1>
    <div class="build-number">Build: 1.2.1</div>
    <div class="file-upload">
      <label class="upload-btn">
        Upload audio file
        <input type="file" id="audioFile" />
      </label>
    </div>
    <div class="currently-playing" id="currentFile">No file loaded</div>
    <div class="pitch-display" id="pitchDisplay">Pitch: 0 cents</div>
    <div class="playback-controls">
      <button class="playback-btn" id="playBtn" disabled>Play</button>
      <button class="playback-btn" id="stopBtn" disabled>Stop</button>
    </div>
    <div class="controls">
      <button class="pitch-btn" id="pitchDown">−</button>
      <button class="pitch-btn" id="pitchUp">+</button>
    </div>
    <div class="adsr-controls">
      <div class="adsr-control"><label>Attack</label><input type="range" id="attack" min="0" max="2" step="0.1" value="0.1"></div>
      <div class="adsr-control"><label>Decay</label><input type="range" id="decay" min="0" max="2" step="0.1" value="0.2"></div>
      <div class="adsr-control"><label>Sustain</label><input type="range" id="sustain" min="0" max="1" step="0.1" value="0.5"></div>
      <div class="adsr-control"><label>Release</label><input type="range" id="release" min="0" max="2" step="0.1" value="0.5"></div>
      <div class="adsr-control"><label>Volume</label><input type="range" id="volume" min="0" max="1" step="0.1" value="0.7"></div>
    </div>
  </div>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let wavBuffer = null;
    let sourceNode = null;
    let gainNode = null;
    let isPlaying = false;
    let currentPitch = 0;

    const fileInput = document.getElementById('audioFile');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const currentFileLabel = document.getElementById('currentFile');
    const pitchDisplay = document.getElementById('pitchDisplay');
    const attackSlider = document.getElementById('attack');
    const decaySlider = document.getElementById('decay');
    const sustainSlider = document.getElementById('sustain');
    const releaseSlider = document.getElementById('release');
    const volumeSlider = document.getElementById('volume');

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (isPlaying) stopPlayback();
      isPlaying = false;
      currentPitch = 0;
      pitchDisplay.textContent = 'Pitch: 0 cents';
      playBtn.textContent = 'Play';
      playBtn.disabled = true;
      stopBtn.disabled = true;
      currentFileLabel.textContent = `Decoding: ${file.name}…`;

      try {
        const arrayBuffer = await file.arrayBuffer();
        wavBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        currentFileLabel.textContent = `Loaded: ${file.name}`;
        playBtn.disabled = false;
        stopBtn.disabled = false;
      } catch (err) {
        console.error('Decode error:', err);
        currentFileLabel.textContent = 'Error loading file';
      }
    });

    function scheduleEnvelope(now) {
      const a = parseFloat(attackSlider.value);
      const d = parseFloat(decaySlider.value);
      const s = parseFloat(sustainSlider.value);
      const r = parseFloat(releaseSlider.value);
      const vol = parseFloat(volumeSlider.value);

      gainNode.gain.cancelScheduledValues(now);
      gainNode.gain.setValueAtTime(0, now);
      gainNode.gain.linearRampToValueAtTime(vol, now + a);
      gainNode.gain.linearRampToValueAtTime(vol * s, now + a + d);
      // release on stop
    }

    function playAudio() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      if (wavBuffer) {
        sourceNode?.stop();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        scheduleEnvelope(now);

        sourceNode = audioCtx.createBufferSource();
        sourceNode.buffer = wavBuffer;
        sourceNode.playbackRate.value = Math.pow(2, currentPitch / 1200);
        sourceNode.connect(gainNode);
        sourceNode.start(now);

        isPlaying = true;
        playBtn.textContent = 'Restart';
        stopBtn.disabled = false;
      }
    }

    function stopPlayback() {
      if (gainNode && sourceNode) {
        const now = audioCtx.currentTime;
        const r = parseFloat(releaseSlider.value);
        const currentGain = gainNode.gain.value;
        gainNode.gain.cancelScheduledValues(now);
        gainNode.gain.setValueAtTime(currentGain, now);
        gainNode.gain.linearRampToValueAtTime(0, now + r);
        sourceNode.stop(now + r);
      }
      isPlaying = false;
      playBtn.textContent = 'Play';
    }

    playBtn.addEventListener('click', playAudio);
    stopBtn.addEventListener('click', stopPlayback);

    function changePitch(cents) {
      currentPitch += cents;
      pitchDisplay.textContent = `Pitch: ${currentPitch.toFixed(1)} cents`;
      if (sourceNode && isPlaying) {
        sourceNode.playbackRate.value = Math.pow(2, currentPitch / 1200);
      }
    }

    ['pitchUp', 'pitchDown'].forEach((id) => {
      const btn = document.getElementById(id);
      let interval;
      const startBend = () => {
        clearInterval(interval);
        interval = setInterval(() => changePitch(id === 'pitchUp' ? 2 : -2), 100);
      };
      const stopBend = () => clearInterval(interval);
      btn.addEventListener('mousedown', startBend);
      btn.addEventListener('touchstart', startBend);
      ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => btn.addEventListener(evt, stopBend));
    });
  </script>
</body>
</html>
